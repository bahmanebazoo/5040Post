# post_analyzer/processors/last_day_processor.py

"""
Ø³Ø§Ø®Øª Ø´ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯ ØªÚ©â€ŒØ±ÙˆØ²Ù‡ (Ø¢Ø®Ø±ÛŒÙ† Ø±ÙˆØ²) Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ù…ÙˆØ¯ÛŒ.
Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ Ø²ÛŒØ± Ù‡Ù…ØŒ Ø§Ù¾Ø±Ø§ØªÙˆØ±Ù‡Ø§ Ú©Ù†Ø§Ø± Ù‡Ù….
"""

import pandas as pd
from typing import Optional


class LastDayProcessor:
    """Ø§Ø² df_daily Ø¢Ø®Ø±ÛŒÙ† Ø±ÙˆØ² Ø±Ø§ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ùˆ Ø¨Ù‡ ÙØ±Ù…Øª Ø¹Ù…ÙˆØ¯ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯."""

    # Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ø² Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†ÛŒÙ… + Ø¹Ù†ÙˆØ§Ù† ÙØ§Ø±Ø³ÛŒ Ø¹Ù…ÙˆØ¯ÛŒ
    PARAM_MAP = {
        'Ø§Ù¾Ø±Ø§ØªÙˆØ±': None,          # Ø§ÛŒÙ† Ø®ÙˆØ¯Ø´ Ù‡Ø¯Ø± Ø³ØªÙˆÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯
        # 'ØªØ§Ø±ÛŒØ®': None,            # Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ù‡Ù…Ù‡ ÛŒÚ© Ø±ÙˆØ² Ù‡Ø³ØªÙ†Ø¯)
        'Ø³Ø§Ø¹Øª Ø§ÙˆÙ„ÛŒÙ† ØªÙ…Ø§Ø³': 'Ø³Ø§Ø¹Øª Ø§ÙˆÙ„ÛŒÙ† ØªÙ…Ø§Ø³',
        'Ø³Ø§Ø¹Øª Ø§ÙˆÙ„ÛŒÙ† Ù¾Ø§Ø³Ø®â€ŒØ¯Ø§Ø¯Ù‡': 'Ø³Ø§Ø¹Øª Ø§ÙˆÙ„ÛŒÙ† Ù¾Ø§Ø³Ø®â€ŒØ¯Ø§Ø¯Ù‡',
        'ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ØªÙ…Ø§Ø³': 'ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ØªÙ…Ø§Ø³',
        'ØªØ¹Ø¯Ø§Ø¯ Ø´Ù…Ø§Ø±Ù‡ ÛŒÙˆÙ†ÛŒÚ© ØªÙ…Ø§Ø³': 'ØªØ¹Ø¯Ø§Ø¯ Ø´Ù…Ø§Ø±Ù‡ ÛŒÙˆÙ†ÛŒÚ© ØªÙ…Ø§Ø³',
        'ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø¨Ø±Ø±Ø³ÛŒ (Ù¾Ù†Ù„)': 'ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø¨Ø±Ø±Ø³ÛŒ (Ù¾Ù†Ù„)',
        'Ù†Ø³Ø¨Øª ØªÙ…Ø§Ø³ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ± (%)': 'Ù†Ø³Ø¨Øª ØªÙ…Ø§Ø³ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ± (%)',
        'ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± Ø¨Ø¯ÙˆÙ† ØªÙ…Ø§Ø³': 'ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± Ø¨Ø¯ÙˆÙ† ØªÙ…Ø§Ø³',
        'Ù†Ø³Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ø¨Ø¯ÙˆÙ† ØªÙ…Ø§Ø³ (%)': 'Ù†Ø³Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ø¨Ø¯ÙˆÙ† ØªÙ…Ø§Ø³ (%)',
        'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† ØªÙ…Ø§Ø³ (Ø«Ø§Ù†ÛŒÙ‡)': 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† ØªÙ…Ø§Ø³ (Ø«Ø§Ù†ÛŒÙ‡)',
        'Ù…ÛŒØ§Ù†Ù‡ ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† ØªÙ…Ø§Ø³ (Ø«Ø§Ù†ÛŒÙ‡)': 'Ù…ÛŒØ§Ù†Ù‡ ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† ØªÙ…Ø§Ø³ (Ø«Ø§Ù†ÛŒÙ‡)',
        'Ø­Ø¯Ø§Ú©Ø«Ø± ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† ØªÙ…Ø§Ø³ (Ø¯Ù‚ÛŒÙ‚Ù‡)': 'Ø­Ø¯Ø§Ú©Ø«Ø± ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† ØªÙ…Ø§Ø³ (Ø¯Ù‚ÛŒÙ‚Ù‡)',
        'Ø­Ø¯Ø§Ù‚Ù„ ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† ØªÙ…Ø§Ø³ (Ø«Ø§Ù†ÛŒÙ‡)': 'Ø­Ø¯Ø§Ù‚Ù„ ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† ØªÙ…Ø§Ø³ (Ø«Ø§Ù†ÛŒÙ‡)',
        'Ú©Ù„ Ø²Ù…Ø§Ù† Ú©Ø§Ø±Ú©Ø±Ø¯ (Ø³Ø§Ø¹Øª)': 'Ú©Ù„ Ø²Ù…Ø§Ù† Ú©Ø§Ø±Ú©Ø±Ø¯ (Ø³Ø§Ø¹Øª)',
        'ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡': 'ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡',
        'ØªØ¹Ø¯Ø§Ø¯ Ø¹Ø¯Ù… Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ': 'ØªØ¹Ø¯Ø§Ø¯ Ø¹Ø¯Ù… Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ',
        'ØªØ¹Ø¯Ø§Ø¯ Ø¹Ø¯Ù… Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø§Ù¾Ø±Ø§ØªÙˆØ±': 'ØªØ¹Ø¯Ø§Ø¯ Ø¹Ø¯Ù… Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø§Ù¾Ø±Ø§ØªÙˆØ±',
        'ØªØ¹Ø¯Ø§Ø¯ Ù…Ø´ØºÙˆÙ„ Ø¨ÙˆØ¯Ù† Ø®Ø·': 'ØªØ¹Ø¯Ø§Ø¯ Ù…Ø´ØºÙˆÙ„ Ø¨ÙˆØ¯Ù† Ø®Ø·',
        'ØªØ¹Ø¯Ø§Ø¯ Ù„ØºÙˆ ØªÙ…Ø§Ø³': 'ØªØ¹Ø¯Ø§Ø¯ Ù„ØºÙˆ ØªÙ…Ø§Ø³',
        'Ø¯Ø±ØµØ¯ ØªÙ…Ø§Ø³ Ù¾Ø³Øª (%)': 'Ø¯Ø±ØµØ¯ ØªÙ…Ø§Ø³ Ù¾Ø³Øª (%)',
        'ØªØ¹Ø¯Ø§Ø¯ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡': 'ØªØ¹Ø¯Ø§Ø¯ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡',
        'ØªØ¹Ø¯Ø§Ø¯ Ø±Ø¯ Ø´Ø¯Ù‡ (Ø¹Ø¯Ù… ØªØ§ÛŒÛŒØ¯)': 'ØªØ¹Ø¯Ø§Ø¯ Ø±Ø¯ Ø´Ø¯Ù‡ (Ø¹Ø¯Ù… ØªØ§ÛŒÛŒØ¯)',
        'Ù†Ø³Ø¨Øª ØªØ§ÛŒÛŒØ¯ (%)': 'Ù†Ø³Ø¨Øª ØªØ§ÛŒÛŒØ¯ (%)',
        'Ù†Ø³Ø¨Øª Ø±Ø¯ (%)': 'Ù†Ø³Ø¨Øª Ø±Ø¯ (%)',
    }

    def process(self, df_daily: pd.DataFrame) -> Optional[pd.DataFrame]:
        """
        Ø¢Ø®Ø±ÛŒÙ† Ø±ÙˆØ² Ø±Ø§ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ùˆ Ø¨Ù‡ ÙØ±Ù…Øª Ø¹Ù…ÙˆØ¯ÛŒ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯.
        Ø³ØªÙˆÙ† Ø§ÙˆÙ„ = 'Ù¾Ø§Ø±Ø§Ù…ØªØ±'ØŒ Ø¨Ù‚ÛŒÙ‡ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ = Ù†Ø§Ù… Ø§Ù¾Ø±Ø§ØªÙˆØ±Ù‡Ø§
        """
        if df_daily is None or df_daily.empty:
            print("[LastDayProcessor] âš ï¸ df_daily Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.")
            return None

        # --- Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¢Ø®Ø±ÛŒÙ† ØªØ§Ø±ÛŒØ® ---
        date_col = 'ØªØ§Ø±ÛŒØ®'
        if date_col not in df_daily.columns:
            print("[LastDayProcessor] âš ï¸ Ø³ØªÙˆÙ† 'ØªØ§Ø±ÛŒØ®' ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return None

        last_date = df_daily[date_col].max()
        print(f"[LastDayProcessor] Ø¢Ø®Ø±ÛŒÙ† Ø±ÙˆØ²: {last_date}")

        df_last = df_daily[df_daily[date_col] == last_date].copy()

        if df_last.empty:
            print("[LastDayProcessor] âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ø±ÙˆØ² ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return None

        # --- Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ ---
        available_params = []
        for col, label in self.PARAM_MAP.items():
            if label is not None and col in df_last.columns:
                available_params.append((col, label))

        if not available_params:
            print("[LastDayProcessor] âš ï¸ Ù‡ÛŒÚ† Ù¾Ø§Ø±Ø§Ù…ØªØ± Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return None

        # --- Ø³Ø§Ø®Øª Ø¯ÛŒØªØ§ÙØ±ÛŒÙ… Ø¹Ù…ÙˆØ¯ÛŒ ---
        operator_col = 'Ø§Ù¾Ø±Ø§ØªÙˆØ±'
        operators = df_last[operator_col].tolist() if operator_col in df_last.columns else []

        if not operators:
            print("[LastDayProcessor] âš ï¸ Ø§Ù¾Ø±Ø§ØªÙˆØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return None

        # Ø³Ø§Ø®Øª Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ: Ù‡Ø± Ø±Ø¯ÛŒÙ = ÛŒÚ© Ù¾Ø§Ø±Ø§Ù…ØªØ±
        rows = []
        for col_name, label in available_params:
            row = {'Ù¾Ø§Ø±Ø§Ù…ØªØ±': label}
            for _, record in df_last.iterrows():
                op_name = record.get(operator_col, '?')
                value = record.get(col_name, '')
                # Ú¯Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ø¹Ø´Ø§Ø±ÛŒ
                if isinstance(value, float):
                    value = round(value, 2)
                row[op_name] = value
            rows.append(row)

        df_vertical = pd.DataFrame(rows)

        # --- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±Ø¯ÛŒÙ ØªØ§Ø±ÛŒØ® Ø¯Ø± Ø¨Ø§Ù„Ø§ ---
        date_row = {'Ù¾Ø§Ø±Ø§Ù…ØªØ±': f'ğŸ“… Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø±ÙˆØ² {last_date}'}
        for op in operators:
            date_row[op] = ''
        df_date = pd.DataFrame([date_row])
        df_vertical = pd.concat([df_date, df_vertical], ignore_index=True)

        print(f"[LastDayProcessor] âœ… Ø´ÛŒØª Ø¹Ù…ÙˆØ¯ÛŒ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯: "
              f"{len(available_params)} Ù¾Ø§Ø±Ø§Ù…ØªØ± Ã— {len(operators)} Ø§Ù¾Ø±Ø§ØªÙˆØ±")

        return df_vertical
